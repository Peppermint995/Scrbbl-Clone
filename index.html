<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skribbl Clone - Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .canvas-container { cursor: crosshair; touch-action: none; }
        canvas { touch-action: none; background-color: white; border-radius: 1rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 overflow-hidden">

    <!-- LOBBY VIEW -->
    <div id="lobby-view" class="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl">
            <div class="text-center mb-8">
                <h1 class="text-6xl font-black text-blue-600 italic tracking-tighter">skribbl.io</h1>
                <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em] mt-2">Public Multiplayer</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-8">
                <div class="flex-1 flex flex-col items-center border-b md:border-b-0 md:border-r border-slate-100 pb-8 md:pb-0 md:pr-8">
                    <div id="avatar-preview" class="w-32 h-32 rounded-3xl flex items-center justify-center text-6xl shadow-xl mb-6 bg-red-500 transition-transform hover:scale-105">
                        üê±
                    </div>
                    <input id="player-name" type="text" placeholder="Your Name..." maxlength="12" class="w-full px-5 py-3 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none font-bold text-center bg-slate-50">
                </div>

                <div class="flex-1 flex flex-col justify-center space-y-4">
                    <button id="quick-play" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-5 rounded-2xl transition-all shadow-lg active:scale-95 disabled:opacity-50 font-black italic text-2xl">
                        QUICK JOIN
                    </button>

                    <div class="relative py-2 flex items-center">
                        <div class="flex-grow border-t border-slate-200"></div>
                        <span class="px-3 text-slate-400 text-[10px] font-black uppercase tracking-widest">Or Code</span>
                        <div class="flex-grow border-t border-slate-200"></div>
                    </div>

                    <div class="flex gap-2">
                        <input id="room-code-input" type="text" placeholder="CODE" maxlength="6" class="w-24 px-2 py-3 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-mono font-bold uppercase text-center">
                        <button id="join-private" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-2xl transition-all">JOIN ROOM</button>
                    </div>
                </div>
            </div>
            <div id="status-display" class="mt-6 p-3 bg-slate-50 text-slate-400 rounded-xl text-xs font-bold text-center">
                Connecting to servers...
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view" class="hidden h-screen flex flex-col md:flex-row overflow-hidden bg-slate-100">
        <!-- Sidebar -->
        <div class="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col shrink-0">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between">
                <h2 class="font-black text-slate-700">PLAYERS</h2>
                <button onclick="location.reload()" class="text-slate-400 hover:text-red-500">üö™</button>
            </div>
            <div id="player-list" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
            <div class="p-4 bg-slate-900 text-white text-xs font-mono text-center" id="display-room-id">ROOM: ---</div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col relative min-w-0">
            <div class="bg-white border-b h-16 flex items-center justify-between px-6 z-10">
                <div class="flex items-center gap-4">
                    <div id="timer-box" class="bg-amber-100 text-amber-700 px-3 py-1 rounded-lg font-black text-xl border border-amber-200">60</div>
                    <div id="word-display" class="font-mono text-xl font-black tracking-[0.4em] text-slate-800">_ _ _ _</div>
                </div>
                <div id="drawer-tools" class="hidden flex items-center gap-2">
                    <button id="clear-btn" class="bg-red-50 text-red-500 px-4 py-2 rounded-xl text-xs font-bold">CLEAR</button>
                    <input id="brush-size" type="range" min="2" max="30" value="5" class="w-24">
                </div>
            </div>

            <div class="flex-1 bg-slate-200 p-4 relative">
                <div class="w-full h-full relative canvas-container" id="canvas-parent">
                    <canvas id="game-canvas" class="w-full h-full shadow-lg"></canvas>
                    <div id="overlay" class="hidden absolute inset-0 bg-black/40 flex items-center justify-center pointer-events-none">
                        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center">
                            <p id="overlay-msg" class="text-xl font-black text-blue-600 italic"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat -->
        <div class="w-full md:w-80 bg-slate-50 border-l border-slate-200 flex flex-col shrink-0">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 no-scrollbar text-sm"></div>
            <form id="chat-form" class="p-4 bg-white border-t flex gap-2">
                <input id="chat-input" type="text" autocomplete="off" placeholder="Guess..." class="flex-1 px-4 py-3 bg-slate-100 rounded-xl outline-none font-bold">
                <button type="submit" class="bg-blue-600 text-white px-4 rounded-xl font-bold">GO</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyBIMQt_N3Z4nLabjV9Erj7SzlvHmhaqo4Q",
            authDomain: "chat-78682.firebaseapp.com",
            projectId: "chat-78682",
            storageBucket: "chat-78682.firebasestorage.app",
            messagingSenderId: "650441779462",
            appId: "1:650441779462:web:8ad0bc03119881ec49d687"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : "skribbl-public-v1";

        let app, auth, db, user = null;
        let currentRoomId = null;
        let isDrawing = false;
        let roomData = null;
        let lastPoints = [];

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const WORDS = ['PIZZA', 'DRAGON', 'CACTUS', 'ROCKET', 'GUITAR', 'IPHONE', 'DONUT', 'BICYCLE', 'PYRAMID', 'CLOUD'];

        async function init() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, u => {
                    user = u;
                    if (u) document.getElementById('status-display').innerText = "Connected! Choose a room.";
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(() => signInAnonymously(auth));
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                document.getElementById('status-display').innerText = "Database error. Please refresh.";
            }
        }

        async function joinRoom(id) {
            if (!user) return;
            const rid = id.toUpperCase().trim();
            if (!rid) return;

            document.getElementById('status-display').innerText = `Joining ${rid}...`;
            const name = document.getElementById('player-name').value.trim() || 'Player' + Math.floor(Math.random()*99);
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', rid);

            try {
                const snap = await getDoc(roomRef);
                const player = { id: user.uid, name, score: 0, avatar: document.getElementById('avatar-preview').innerText };

                if (!snap.exists()) {
                    await setDoc(roomRef, {
                        id: rid,
                        players: [player],
                        lines: [],
                        messages: [{ sender: 'System', text: 'Game started!', system: true }],
                        currentDrawer: user.uid,
                        currentWord: WORDS[Math.floor(Math.random() * WORDS.length)],
                        timer: 80
                    });
                } else {
                    const data = snap.data();
                    const existing = (data.players || []).find(p => p.id === user.uid);
                    if (!existing) {
                        await updateDoc(roomRef, { players: arrayUnion(player) });
                    }
                }

                currentRoomId = rid;
                document.getElementById('lobby-view').classList.add('hidden');
                document.getElementById('game-view').classList.remove('hidden');
                document.getElementById('display-room-id').innerText = `ROOM: ${rid}`;
                
                resize();
                listen();
                heartbeat();
            } catch (err) {
                console.error(err);
                document.getElementById('status-display').innerText = "Join Error: Check connection.";
            }
        }

        function listen() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), (s) => {
                if (!s.exists()) return;
                roomData = s.data();
                renderUI();
                if (!isDrawing) drawLines(roomData.lines || []);
            });
        }

        function heartbeat() {
            setInterval(async () => {
                if (!roomData || roomData.currentDrawer !== user.uid) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                let t = (roomData.timer || 80) - 1;
                if (t <= 0) {
                    const players = roomData.players || [];
                    const idx = players.findIndex(p => p.id === user.uid);
                    const next = players[(idx + 1) % players.length]?.id || user.uid;
                    await updateDoc(roomRef, {
                        timer: 80,
                        currentDrawer: next,
                        currentWord: WORDS[Math.floor(Math.random() * WORDS.length)],
                        lines: []
                    });
                } else {
                    await updateDoc(roomRef, { timer: t });
                }
            }, 1000);
        }

        function renderUI() {
            const list = document.getElementById('player-list');
            list.innerHTML = roomData.players.map(p => `
                <div class="flex items-center gap-2 p-2 ${p.id === user.uid ? 'bg-blue-50' : ''} rounded-lg">
                    <span class="text-xl">${p.avatar}</span>
                    <div class="flex-1">
                        <p class="text-xs font-black truncate">${p.name}</p>
                        <p class="text-[10px] text-blue-600 font-bold">${p.score} pts</p>
                    </div>
                    ${roomData.currentDrawer === p.id ? '‚úèÔ∏è' : ''}
                </div>
            `).join('');

            document.getElementById('timer-box').innerText = roomData.timer;
            const isDrawer = roomData.currentDrawer === user.uid;
            document.getElementById('word-display').innerText = isDrawer ? roomData.currentWord : roomData.currentWord.replace(/[A-Z]/g, '_ ');
            document.getElementById('drawer-tools').classList.toggle('hidden', !isDrawer);
            document.getElementById('chat-input').disabled = isDrawer;
            document.getElementById('chat-input').placeholder = isDrawer ? "You are drawing!" : "Guess...";

            const chat = document.getElementById('chat-messages');
            chat.innerHTML = (roomData.messages || []).map(m => `
                <div class="${m.system ? 'text-green-600 italic font-bold' : ''}">
                    <strong>${m.sender}:</strong> ${m.text}
                </div>
            `).join('');
            chat.scrollTop = chat.scrollHeight;
        }

        function drawLines(lines) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            lines.forEach(l => {
                ctx.beginPath();
                ctx.strokeStyle = '#000';
                ctx.lineWidth = l.size || 5;
                l.points.forEach((p, i) => {
                    const x = p.x * canvas.width;
                    const y = p.y * canvas.height;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            });
        }

        function getMouse(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / canvas.width, y: (clientY - rect.top) / canvas.height };
        }

        canvas.onmousedown = (e) => {
            if (roomData?.currentDrawer !== user.uid) return;
            isDrawing = true;
            lastPoints = [getMouse(e)];
        };
        window.onmousemove = (e) => {
            if (!isDrawing) return;
            lastPoints.push(getMouse(e));
            const currentLines = [...(roomData.lines || []), { size: document.getElementById('brush-size').value, points: lastPoints }];
            drawLines(currentLines);
        };
        window.onmouseup = async () => {
            if (!isDrawing) return;
            isDrawing = false;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            await updateDoc(roomRef, { lines: [...(roomData.lines || []), { size: document.getElementById('brush-size').value, points: lastPoints }] });
        };

        // Touch
        canvas.ontouchstart = (e) => { e.preventDefault(); canvas.onmousedown(e); };
        canvas.ontouchmove = (e) => { e.preventDefault(); window.onmousemove(e); };
        canvas.ontouchend = (e) => { window.onmouseup(); };

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const val = document.getElementById('chat-input').value.trim().toUpperCase();
            if (!val) return;
            const isCorrect = val === roomData.currentWord;
            const name = roomData.players.find(p => p.id === user.uid).name;
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);

            if (isCorrect) {
                const nextWord = WORDS[Math.floor(Math.random() * WORDS.length)];
                const players = roomData.players.map(p => p.id === user.uid ? {...p, score: p.score + 10} : p);
                const nextIdx = (players.findIndex(p => p.id === roomData.currentDrawer) + 1) % players.length;
                await updateDoc(roomRef, {
                    players,
                    currentDrawer: players[nextIdx].id,
                    currentWord: nextWord,
                    lines: [],
                    timer: 80,
                    messages: arrayUnion({ sender: 'System', text: `${name} guessed it!`, system: true })
                });
            } else {
                await updateDoc(roomRef, { messages: arrayUnion({ sender: name, text: val }) });
            }
            document.getElementById('chat-input').value = '';
        };

        document.getElementById('quick-play').onclick = () => {
            // Join one of 3 public lobbies immediately
            const lobbyNum = Math.floor(Math.random() * 3) + 1;
            joinRoom(`LOBBY${lobbyNum}`);
        };
        document.getElementById('join-private').onclick = () => joinRoom(document.getElementById('room-code-input').value || 'ROOM1');
        document.getElementById('clear-btn').onclick = () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { lines: [] });

        function resize() {
            canvas.width = document.getElementById('canvas-parent').clientWidth;
            canvas.height = document.getElementById('canvas-parent').clientHeight;
            if (roomData) drawLines(roomData.lines);
        }

        window.onresize = resize;
        init();
    </script>
</body>
</html>
