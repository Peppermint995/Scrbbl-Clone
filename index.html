<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skribbl Clone - Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .canvas-container { cursor: crosshair; }
        input[type="range"] { accent-color: #2563eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        canvas { touch-action: none; background-color: white; border-radius: 1rem; }
    </style>
</head>
<body class="bg-slate-100 overflow-hidden">

    <!-- LOBBY VIEW -->
    <div id="lobby-view" class="min-h-screen bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-2xl overflow-hidden">
            <div class="text-center mb-8">
                <h1 class="text-6xl font-black text-blue-600 italic tracking-tighter drop-shadow-sm">skribbl.io</h1>
                <p class="text-slate-400 font-bold uppercase text-[10px] tracking-[0.3em] mt-2">Multiplayer Edition</p>
            </div>
            
            <div class="flex flex-col md:flex-row gap-8">
                <!-- Profile Customization -->
                <div class="flex-1 flex flex-col items-center border-b md:border-b-0 md:border-r border-slate-100 pb-8 md:pb-0 md:pr-8">
                    <div id="avatar-preview" class="w-40 h-40 rounded-[2.5rem] flex items-center justify-center text-7xl shadow-xl mb-6 bg-red-500 transition-transform hover:scale-105 cursor-default select-none">
                        üê±
                    </div>
                    
                    <input id="player-name" type="text" placeholder="Your Name..." maxlength="12" class="w-full px-5 py-4 border-2 border-slate-100 rounded-2xl focus:border-blue-500 outline-none font-bold text-center text-lg shadow-inner bg-slate-50">

                    <div class="mt-6 w-full space-y-4">
                        <div id="color-grid" class="grid grid-cols-4 gap-2"></div>
                        <div id="icon-grid" class="grid grid-cols-6 gap-2"></div>
                    </div>
                </div>

                <!-- Connection Options -->
                <div class="flex-1 flex flex-col justify-center space-y-4">
                    <button id="quick-play" class="group w-full bg-blue-600 hover:bg-blue-700 text-white p-6 rounded-2xl transition-all shadow-lg active:scale-95 disabled:opacity-50" disabled>
                        <div class="flex items-center justify-between">
                            <div class="text-left">
                                <p class="text-2xl font-black italic">QUICK JOIN</p>
                                <p class="text-blue-200 text-xs font-bold uppercase tracking-widest">Public Lobby</p>
                            </div>
                            <span class="text-3xl opacity-50 group-hover:opacity-100">üåç</span>
                        </div>
                    </button>

                    <div class="relative py-2">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t-2 border-slate-100"></span></div>
                        <div class="relative flex justify-center text-[10px] uppercase font-black text-slate-300 tracking-widest"><span class="bg-white px-3">Private Match</span></div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input id="room-code-input" type="text" placeholder="CODE..." maxlength="6" class="flex-1 px-4 py-4 bg-slate-50 border-2 border-slate-100 rounded-2xl focus:border-purple-500 outline-none font-mono font-bold uppercase tracking-widest text-center">
                            <button id="create-private" class="bg-purple-600 hover:bg-purple-700 text-white px-6 rounded-2xl transition-all shadow-lg active:scale-90 flex items-center justify-center">
                                <span class="text-2xl font-bold">+</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GAME VIEW -->
    <div id="game-view" class="hidden h-screen flex flex-col md:flex-row overflow-hidden bg-slate-100">
        <!-- Sidebar: Players -->
        <div class="w-full md:w-64 bg-white border-r border-slate-200 flex flex-col shrink-0 shadow-lg">
            <div class="p-4 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                <h2 class="font-black italic text-slate-700 flex items-center gap-2">üë• PLAYERS</h2>
                <button id="exit-game" class="text-slate-400 hover:text-red-500 transition-colors text-xl">üö™</button>
            </div>
            <div id="player-list" class="flex-1 overflow-y-auto p-2 space-y-1 no-scrollbar"></div>
            <div class="p-4 bg-slate-900 text-white flex items-center justify-between">
                <div class="flex flex-col">
                    <span class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Room Code</span>
                    <span id="display-room-id" class="text-xs font-mono font-bold tracking-widest text-blue-400">---</span>
                </div>
                <button id="copy-code-btn" class="hover:text-blue-400 p-2">üìã</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col relative min-w-0">
            <div class="bg-white border-b border-slate-200 flex flex-col z-10">
                <div class="h-16 flex items-center justify-between px-6">
                    <div class="flex items-center gap-4">
                        <div id="timer-box" class="bg-amber-100 text-amber-700 w-12 h-12 rounded-xl flex items-center justify-center font-black text-xl border-2 border-amber-200">60</div>
                        <div>
                            <p class="text-[10px] text-slate-400 uppercase font-black tracking-[0.2em] leading-none mb-1">Current Word</p>
                            <p id="word-display" class="font-mono text-xl font-black tracking-[0.4em] text-slate-800">_ _ _ _</p>
                        </div>
                    </div>
                    <div id="drawer-tools" class="hidden items-center gap-2">
                        <button id="eraser-btn" class="p-2.5 bg-slate-100 text-slate-600 rounded-xl hover:bg-slate-200 border-2 border-transparent transition-all">üßΩ</button>
                        <button id="clear-btn" class="p-2.5 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 transition-all">üóëÔ∏è</button>
                    </div>
                </div>

                <div id="tool-bar" class="hidden h-20 bg-slate-50 border-t border-slate-100 items-center px-6 gap-6 overflow-x-auto no-scrollbar">
                    <div class="flex flex-col shrink-0 gap-1 min-w-[120px]">
                        <div class="flex justify-between items-center text-[10px] font-bold text-slate-500 uppercase">
                            <span>Brush Size</span>
                            <span id="brush-size-label">5px</span>
                        </div>
                        <input id="brush-size" type="range" min="2" max="40" value="5" class="w-full">
                    </div>
                    <div class="h-10 w-[2px] bg-slate-200 shrink-0"></div>
                    <div id="palette" class="flex flex-wrap gap-1.5 py-2"></div>
                </div>
            </div>

            <div class="flex-1 bg-slate-200 p-4 relative overflow-hidden">
                <div class="w-full h-full relative overflow-hidden canvas-container">
                    <canvas id="game-canvas" class="w-full h-full shadow-lg"></canvas>
                    
                    <div id="drawer-overlay" class="hidden absolute inset-0 bg-slate-900/5 pointer-events-none flex flex-col items-center justify-center">
                        <div class="bg-white/95 backdrop-blur-md px-8 py-4 rounded-3xl border border-white shadow-2xl flex items-center gap-4 text-slate-800 font-bold italic animate-bounce">
                            <span class="text-3xl">üé®</span>
                            <div class="leading-tight">
                                <span id="drawer-name-notif" class="text-blue-600">Player</span>
                                <p class="text-xs text-slate-400 not-italic uppercase tracking-widest">is drawing...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar: Chat -->
        <div class="w-full md:w-80 bg-slate-50 border-l border-slate-200 flex flex-col shrink-0 h-64 md:h-full">
            <div class="p-4 border-b border-slate-200 bg-white">
                <h2 class="font-black italic flex items-center gap-2 text-slate-700 text-xs tracking-widest uppercase">üí¨ Feed</h2>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2 no-scrollbar"></div>
            <form id="chat-form" class="p-4 bg-white border-t border-slate-200 flex gap-2">
                <input id="chat-input" type="text" autocomplete="off" placeholder="Guess the word..." class="flex-1 px-4 py-3 bg-slate-100 border-none rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold disabled:opacity-50">
                <button id="chat-submit" type="submit" class="p-3 bg-blue-600 text-white rounded-2xl shadow-lg active:scale-95 transition-all">üì§</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // FALLBACK CONFIG FOR GITHUB PAGES
        const defaultFirebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : defaultFirebaseConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "skribbl-public-v1";

        // GAME CONSTANTS
        const WORDS = ['Pizza', 'Elephant', 'Laptop', 'Rocket', 'Cactus', 'Volcano', 'Guitar', 'Bicycle', 'Snowman', 'Pyramid', 'Donut', 'Pencil', 'Castle', 'Dragon', 'Camera', 'Balloon', 'Lighthouse', 'Burger', 'Submarine', 'Sunflower'];
        const AVATAR_COLORS = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899', '#64748b', '#06b6d4'];
        const AVATAR_ICONS = ['üê±', 'üê∂', 'ü¶ä', 'üê®', 'ü¶Å', 'üê∏', 'ü¶Ñ', 'üêº', 'ü§ñ', 'üëæ', 'üëª', 'ü§°'];
        const PALETTE = ['#000000', '#ffffff', '#7f7f7f', '#ee1b24', '#ff7e26', '#fef200', '#22b14c', '#00a2e8', '#3f48cc', '#a349a4', '#b97a57', '#ffaec9'];

        // STATE
        let user = null;
        let currentRoomId = null;
        let isDrawing = false;
        let roomData = null;
        let localLines = [];
        let selectedAvatarColor = AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];
        let selectedAvatarIcon = AVATAR_ICONS[Math.floor(Math.random() * AVATAR_ICONS.length)];
        let currentColor = '#000000';
        let brushSize = 5;
        let isErasing = false;

        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        const lobbyView = document.getElementById('lobby-view');
        const gameView = document.getElementById('game-view');
        const chatMessages = document.getElementById('chat-messages');

        function initLobbyUI() {
            const colorGrid = document.getElementById('color-grid');
            const iconGrid = document.getElementById('icon-grid');
            const paletteEl = document.getElementById('palette');

            AVATAR_COLORS.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "h-8 rounded-lg border-2 border-transparent hover:scale-110 transition-all";
                btn.style.backgroundColor = c;
                btn.onclick = () => { selectedAvatarColor = c; document.getElementById('avatar-preview').style.backgroundColor = c; };
                colorGrid.appendChild(btn);
            });

            AVATAR_ICONS.forEach(i => {
                const btn = document.createElement('button');
                btn.className = "text-2xl p-1 rounded-xl hover:bg-slate-100 hover:scale-110 transition-all select-none";
                btn.innerText = i;
                btn.onclick = () => { selectedAvatarIcon = i; document.getElementById('avatar-preview').innerText = i; };
                iconGrid.appendChild(btn);
            });

            PALETTE.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "w-7 h-7 rounded-full border-2 border-white shadow-sm hover:scale-125 transition-all";
                btn.style.backgroundColor = c;
                btn.onclick = () => { currentColor = c; isErasing = false; document.getElementById('eraser-btn').style.borderColor = 'transparent'; };
                paletteEl.appendChild(btn);
            });

            document.getElementById('avatar-preview').style.backgroundColor = selectedAvatarColor;
            document.getElementById('avatar-preview').innerText = selectedAvatarIcon;
        }

        async function initAuth() {
            onAuthStateChanged(auth, u => {
                user = u;
                document.getElementById('quick-play').disabled = false;
            });
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth).catch(e => console.warn("Anon auth failed, check Firebase settings", e));
            }
        }

        async function joinRoom(roomId, isPrivate) {
            if (!user) return;
            const name = document.getElementById('player-name').value.trim() || 'Player' + Math.floor(Math.random()*1000);
            currentRoomId = roomId.toUpperCase();
            
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            const playerInfo = { 
                id: user.uid, 
                name: name, 
                score: 0, 
                avatarColor: selectedAvatarColor, 
                avatarIcon: selectedAvatarIcon,
                lastSeen: Date.now()
            };

            const snap = await getDoc(roomRef);
            if (!snap.exists()) {
                await setDoc(roomRef, {
                    id: currentRoomId,
                    isPrivate,
                    players: [playerInfo],
                    currentDrawer: user.uid,
                    currentWord: WORDS[Math.floor(Math.random() * WORDS.length)].toLowerCase(),
                    lines: [],
                    messages: [],
                    timer: 80,
                    lastTick: Date.now()
                });
            } else {
                const data = snap.data();
                if (!data.players.find(p => p.id === user.uid)) {
                    await updateDoc(roomRef, { players: arrayUnion(playerInfo) });
                }
            }

            lobbyView.classList.add('hidden');
            gameView.classList.remove('hidden');
            document.getElementById('display-room-id').innerText = currentRoomId;
            
            setTimeout(() => {
                resizeCanvas();
                listenToRoom();
                startHeartbeat();
            }, 200);
        }

        function listenToRoom() {
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            onSnapshot(roomRef, (snapshot) => {
                if (!snapshot.exists()) return;
                roomData = snapshot.data();
                updateUI();
                if (!isDrawing) redrawCanvas(roomData.lines);
            });
        }

        function startHeartbeat() {
            // Very simple timer logic: the drawer is responsible for updating the timer in Firestore
            setInterval(async () => {
                if (!roomData || roomData.currentDrawer !== user.uid) return;
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                let newTimer = (roomData.timer || 80) - 1;
                
                if (newTimer <= 0) {
                    // Turn over
                    const players = roomData.players;
                    const drawerIdx = players.findIndex(p => p.id === user.uid);
                    const nextIdx = (drawerIdx + 1) % players.length;
                    await updateDoc(roomRef, {
                        timer: 80,
                        currentDrawer: players[nextIdx].id,
                        currentWord: WORDS[Math.floor(Math.random() * WORDS.length)].toLowerCase(),
                        lines: [],
                        messages: arrayUnion({ sender: 'System', text: `Time's up! The word was: ${roomData.currentWord}`, system: true })
                    });
                } else {
                    await updateDoc(roomRef, { timer: newTimer });
                }
            }, 1000);
        }

        function updateUI() {
            const isDrawer = roomData.currentDrawer === user.uid;
            
            // Player List
            const list = document.getElementById('player-list');
            list.innerHTML = '';
            [...roomData.players].sort((a,b) => b.score - a.score).forEach(p => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-2xl ${p.id === user.uid ? 'bg-blue-50 border border-blue-200' : 'bg-slate-50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl shadow-sm" style="background:${p.avatarColor}">${p.avatarIcon}</div>
                        <div class="leading-none">
                            <p class="text-sm font-black text-slate-800">${p.name}</p>
                            <p class="text-[10px] text-blue-600 font-black uppercase mt-1">${p.score} pts</p>
                        </div>
                    </div>
                    ${roomData.currentDrawer === p.id ? '‚úèÔ∏è' : ''}
                `;
                list.appendChild(div);
            });

            document.getElementById('timer-box').innerText = roomData.timer || 0;
            const word = roomData.currentWord || "";
            document.getElementById('word-display').innerText = isDrawer 
                ? word.toUpperCase().split('').join(' ') 
                : word.split('').map(() => '_').join(' ');

            const chatInput = document.getElementById('chat-input');
            if (isDrawer) {
                chatInput.disabled = true;
                chatInput.placeholder = "Drawing...";
                document.getElementById('drawer-tools').classList.remove('hidden');
                document.getElementById('tool-bar').classList.remove('hidden');
                document.getElementById('drawer-overlay').classList.add('hidden');
            } else {
                chatInput.disabled = false;
                chatInput.placeholder = "Guess...";
                document.getElementById('drawer-tools').classList.add('hidden');
                document.getElementById('tool-bar').classList.add('hidden');
                document.getElementById('drawer-overlay').classList.remove('hidden');
                const dr = roomData.players.find(p => p.id === roomData.currentDrawer);
                document.getElementById('drawer-name-notif').innerText = dr ? dr.name : 'Someone';
            }

            chatMessages.innerHTML = '';
            roomData.messages.slice(-40).forEach(m => {
                const div = document.createElement('div');
                div.className = `p-2 rounded-xl text-sm ${m.system ? 'bg-green-100 text-green-800 font-bold' : 'bg-white shadow-sm border border-slate-100'}`;
                div.innerHTML = `<strong>${m.sender}:</strong> ${m.text}`;
                chatMessages.appendChild(div);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            if (roomData) redrawCanvas(roomData.lines);
        }

        function redrawCanvas(lines) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            lines.forEach(line => {
                if (!line.points.length) return;
                ctx.beginPath();
                ctx.strokeStyle = line.color;
                ctx.lineWidth = line.size;
                line.points.forEach((p, i) => {
                    const x = p.x * canvas.width;
                    const y = p.y * canvas.height;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                });
                ctx.stroke();
            });
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: (clientX - rect.left) / canvas.width, y: (clientY - rect.top) / canvas.height };
        }

        canvas.addEventListener('mousedown', (e) => {
            if (!roomData || roomData.currentDrawer !== user.uid) return;
            isDrawing = true;
            localLines = [...roomData.lines, { color: isErasing ? '#ffffff' : currentColor, size: brushSize, points: [getPos(e)] }];
            redrawCanvas(localLines);
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            localLines[localLines.length - 1].points.push(getPos(e));
            redrawCanvas(localLines);
        });

        window.addEventListener('mouseup', async () => {
            if (!isDrawing) return;
            isDrawing = false;
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { lines: localLines });
        });

        // Touch support
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); /* trigger mousedown logic */ });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); /* trigger mousemove logic */ });

        document.getElementById('chat-form').onsubmit = async (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const val = input.value.trim();
            if (!val || roomData.currentDrawer === user.uid) return;

            const isCorrect = val.toLowerCase() === roomData.currentWord.toLowerCase();
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            
            const msg = { sender: document.getElementById('player-name').value || 'Guest', text: isCorrect ? 'Guessed the word! ‚ú®' : val, system: isCorrect };
            let updates = { messages: arrayUnion(msg) };

            if (isCorrect) {
                const players = [...roomData.players];
                const drawerIdx = players.findIndex(p => p.id === roomData.currentDrawer);
                const nextIdx = (drawerIdx + 1) % players.length;
                updates.players = players.map(p => p.id === user.uid ? {...p, score: p.score + 10} : p);
                updates.currentDrawer = players[nextIdx].id;
                updates.currentWord = WORDS[Math.floor(Math.random() * WORDS.length)].toLowerCase();
                updates.lines = [];
                updates.timer = 80;
            }
            
            await updateDoc(roomRef, updates);
            input.value = '';
        };

        document.getElementById('quick-play').onclick = async () => {
            const snap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'rooms'));
            let target = null;
            snap.forEach(d => { if (!d.data().isPrivate && d.data().players.length < 8) target = d.id; });
            joinRoom(target || 'ROOM' + Math.floor(Math.random()*1000), false);
        };

        document.getElementById('create-private').onclick = () => {
            const custom = document.getElementById('room-code-input').value.trim();
            joinRoom(custom || Math.random().toString(36).substring(7).toUpperCase(), true);
        };

        document.getElementById('brush-size').oninput = (e) => {
            brushSize = parseInt(e.target.value);
            document.getElementById('brush-size-label').innerText = brushSize + 'px';
        };

        document.getElementById('eraser-btn').onclick = () => {
            isErasing = !isErasing;
            document.getElementById('eraser-btn').style.borderColor = isErasing ? '#2563eb' : 'transparent';
        };

        document.getElementById('clear-btn').onclick = async () => {
            if (roomData.currentDrawer === user.uid) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId), { lines: [] });
            }
        };

        document.getElementById('exit-game').onclick = () => location.reload();
        window.addEventListener('resize', resizeCanvas);
        initLobbyUI(); initAuth();
    </script>
</body>
</html>
